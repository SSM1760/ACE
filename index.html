

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>욕실 견적서 프로그램</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
    }

    .category, .estimate, .items {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .category {
      flex: 0 0 220px;
      max-height: 100vh;
      overflow-y: auto;
      position: sticky;
      top: 20px;
    }

    .items {
      flex: 1 1 700px;
      max-width: 1000px;
    }

    .estimate {
  flex: 0 0 280px;
}

    h3 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 12px;
    }

    .main-category {
      font-size: 15px;
      color: #222;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
      margin-top: 20px;
    }

    .sub-category {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 0;
  margin: 10px 0 20px 0;
}

.sub-category li {
  font-size: 13px;
  color: #0077cc;
  padding: 4px 10px;
  background: #f0f8ff;
  border-radius: 5px;
  cursor: pointer;
  list-style: none;
  white-space: nowrap;
  transition: background 0.2s;
}

.sub-category li:hover {
  background: #dcefff;
  text-decoration: underline;
}

    .items #items {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

    .item {
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 16px;
      background: #fff;
      text-align: center;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s;
position: relative;
z-index: 0;
    }

.item.selected-border {
  border: 2px solid red !important;
}

    .item:hover {
      transform: translateY(-3px);
    }

    .item img {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 12px;
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .item .name {
      font-weight: bold;
      font-size: 15px;
      margin-top: 4px;
      color: #222;
    }

    .item .price {
      font-size: 14px;
      color: #666;
    }

    .item .control {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }

    .item .control input[type="number"] {
      width: 48px;
      height: 36px;
      font-size: 14px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .item .control button {
      height: 40px;
      padding: 0 14px;
      font-size: 15px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    .sort-box {
      text-align: right;
      margin-bottom: 10px;
    }

    .estimate ul {
      list-style: none;
      padding-left: 0;
    }

    .estimate-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .estimate-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 10px;
    }

    .estimate-item .info-line {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .estimate-item .info-line div:first-child {
      font-weight: bold;
      font-size: 15px;
    }

    .estimate-item .info-line div:last-child {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .price-delete {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .price-delete span {
      font-weight: bold;
      white-space: nowrap;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }

    .delete-btn:hover {
      color: red;
    }

    .admin {
      display: none;
      background-color: #f9f9f9;
      width: 90%;
      margin: 30px auto 0;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    #totalWrapper {
      display: none;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    button {
      margin-top: 10px;
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      color: #333;
      font-size: 15px;
      border-radius: 5px;
      padding: 8px 16px;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #e0e0e0;
    }

    textarea {
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      font-family: inherit;
      resize: none;
    }
#modalSummaryText {
  font-size: 26px !important;
  line-height: 1.6;
}

    #imageModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #imageModal img {
      max-width: 700px;
      max-height: 700px;
      width: 100%;
      height: auto;
      border: 5px solid #fff;
      border-radius: 10px;
    }

    #imageModal button {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 24px;
      background: none;
      color: white;
      border: none;
      cursor: pointer;
    }

#prevBtn, #nextBtn {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  font-size: 60px;
  color: white;
  background: none;
  border: none;
  cursor: pointer;
  z-index: 1001;
  padding: 0;
  margin: 0;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#prevBtn {
  left: 10px;
}

#nextBtn {
  right: 10px;
}
.best-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: orange;
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
z-index: 5;
}

.basic-badge {
  position: absolute;
  top: 8px;
  left: 56px; /* BEST 배지 오른쪽 */
  background: #3ca7ff; /* 차분한 파란색 */
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
z-index: 5;
}

.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.detail-btn {
  margin-top: 8px;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(6px);
  border: 1px solid #ddd;
  border-radius: 8px;
  color: #333;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.detail-btn:hover {
  background: rgba(240,240,240,0.8);
  border-color: #bbb;
}

.soldout-wrapper {
  position: relative;
}

.soldout-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(220, 220, 220, 0.4); /* 연한 회색 배경 */
  display: flex;
  justify-content: center;
  align-items: center;
  color: #333;
  font-weight: bold;
  font-size: 1.2em;
  border-radius: 8px;
  z-index: 4;
}

@media (max-width: 1100px) {
  body > div {
    flex-direction: column;
    padding: 10px;
  }

.estimate-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

.estimate-buttons button {
  width: 100%;
}

  .category, .items, .estimate {
    width: 100% !important;
    max-width: 100%;
  }

  .category {
    order: 1;
  }

  .items {
    order: 2;
  }

  .estimate {
    order: 3;
    margin-top: 10px;
  }

  .items #items {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .item {
    font-size: 15px;
  }

  .item .control button {
    padding: 0 12px;
  }

  .item .control input[type="number"] {
    width: 40px;
  }

  .estimate {
    position: relative;
    top: auto;
  }

.estimate-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 12px;
}

.estimate-buttons-row {
  display: flex;
  gap: 10px;
}

.estimate-buttons button {
  flex: 1;
  white-space: nowrap;
  padding: 8px 12px;
  font-size: 14px;
}

#itemsPanel {
  opacity: 0;
  transition: opacity 0.5s ease;
}
#itemsPanel.show {
  opacity: 1;
}
.detail-btn {
  margin-top: 6px;
  background-color: #f7f9fb;
  border: 1px solid #ccd8e0;
  color: #333;
  font-size: 14px;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.detail-btn:hover {
  background-color: #e6eff7;
  border-color: #a8c4d9;
  color: #0077cc;
}
  </style>

</head>
<body>
  <div style="display: flex; gap: 20px; padding: 20px;">
    <div class="category">
      <h3>자재 카테고리</h3>
      <button onclick="toggleAdmin()">🔧 관리자 모드</button>
      <hr />
      <div class="main-category">장 · 거울</div>
      <ul class="sub-category">
        <li onclick="selectCategory('상 · 하단장')">상 · 하단장</li>
        <li onclick="selectCategory('욕실장')">욕실장</li>
        <li onclick="selectCategory('슬라이드장')">슬라이드장</li>
        <li onclick="selectCategory('플랩장')">플랩장</li>
        <li onclick="selectCategory('거울')">거울</li>
        <li onclick="selectCategory('하부장')">하부장</li>
      </ul>

      <div class="main-category">도기</div>
      <ul class="sub-category">
        <li onclick="selectCategory('세면기')">세면기</li>
        <li onclick="selectCategory('양변기(원피스)')">양변기(원피스)</li>
        <li onclick="selectCategory('양변기(투피스)')">양변기(투피스)</li>
        <li onclick="selectCategory('탑볼')">탑볼</li>
      </ul>

      <div class="main-category">수전</div>
      <ul class="sub-category">
        <li onclick="selectCategory('세면수전')">세면수전</li>
        <li onclick="selectCategory('샤워기')">샤워기</li>
        <li onclick="selectCategory('해바라기')">해바라기</li>
        <li onclick="selectCategory('탑볼수전')">탑볼수전</li>
      </ul>

      <div class="main-category">악세사리</div>
<ul class="sub-category">
  <li onclick="selectCategory('수건걸이')">수건걸이</li>
  <li onclick="selectCategory('슬라이드바')">슬라이드바</li>
  <li onclick="selectCategory('휴지걸이')">휴지걸이</li>
  <li onclick="selectCategory('코너선반')">코너선반</li>
  <li onclick="selectCategory('대리석')">대리석</li>
  <li onclick="selectCategory('스프레이건')">스프레이건</li>
</ul>

<div class="main-category">기타</div>
<ul class="sub-category">
  <li onclick="selectCategory('타일')">타일</li>
  <li onclick="selectCategory('욕조')">욕조</li>
  <li onclick="selectCategory('파티션')">파티션</li>
  <li onclick="selectCategory('천장')">천장</li>
</ul>

<hr style="margin: 10px 0;" />

<ul class="sub-category">
<li onclick="selectCategory('철거')">철거</li>
  <li onclick="selectCategory('시공비')">시공비</li>
  <li onclick="selectCategory('별도 시공비')">별도 시공비</li>
</ul>

<hr style="margin: 10px 0;" />

<ul class="sub-category">
  <li onclick="selectCategory('세트')" id="setCategoryLi">별도금액</li>
 <li onclick="selectCategory('메인')">메인</li>
</ul>

    </div>

    <div class="items fade-in" id="itemsPanel">
      <h3>자재 목록</h3>
      <div class="sort-box">
        정렬:
        <select onchange="sortMaterials(this.value)">
          <option value="">기본순</option>
          <option value="name">이름순</option>
          <option value="price">가격순</option>
        </select>
      </div>
      <div id="addAllSetButton" style="display:none; text-align:right; margin-bottom:10px;">
        <button onclick="addAllFromSet()">모두 추가</button>
      </div>
      <div id="items"></div>
    </div>

    <div class="estimate">
      <h3 id="estimateTitle">견적서</h3>
      <ul id="selectedItems"></ul>
      <p id="totalWrapper"><strong>총액: </strong><span id="totalPrice">0</span>원</p>
      <button onclick="summarizeEstimate()">정리</button>
<button onclick="clearEstimate()" style="margin-left: 10px;">전체 삭제</button>

      <textarea id="summaryText" style="width:100%; height:100px; margin-top:10px;"></textarea>
<button onclick="copySummaryText()" style="margin-top: 8px;">복사</button>
<button onclick="toggleSummaryModal()" style="margin-top: 8px;">확대</button>
<div class="estimate-buttons">
  <div class="estimate-buttons-row">
<button onclick="saveEstimate(1); updateEstimateTitle('거실')">📥 저장(거실)</button>
<button onclick="saveEstimate(2); updateEstimateTitle('안방')">📥 저장(안방)</button>
  </div>
  <div class="estimate-buttons-row">
    <button onclick="loadSavedEstimate(1)">📂 확인(거실)</button>
    <button onclick="loadSavedEstimate(2)">📂 확인(안방)</button>
  </div>
  <!-- ✅ 세트 버튼 추가 -->
  <div class="estimate-buttons-row" style="margin-top: 24px;">
  <button onclick="saveEstimate(3); updateEstimateTitle('세트')">📥 저장(세트)</button>
  <button onclick="loadSavedEstimate(3)">📂 확인(세트)</button>
</div>

<!-- 체크리스트 제목과 항목을 새 블록으로 분리 -->
<div style="margin-top: 40px; text-align: center;">
  <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">체크리스트</div>
  <div id="categoryTextGroup" style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 14px; justify-content: center;">
    <span id="text-타일">타일</span>
    <span id="text-양변기">양변기</span>
    <span id="text-세면기">세면기</span>
    <span id="text-세면수전">세면수전</span>
    <span id="text-샤워기">샤워기</span>
    <span id="text-욕실장">욕실장</span>
    <span id="text-슬라이드바">슬라이드바</span>
    <span id="text-수건걸이">수건걸이</span>
    <span id="text-휴지걸이">휴지걸이</span>
    <span id="text-대리석">대리석</span>
    <span id="text-코너선반">코너선반</span>
    <span id="text-천장">천장</span>
    <span id="text-욕조">욕조</span>
    <span id="text-파티션">파티션</span>
  </div>
</div>

<div style="margin-top: 40px; text-align: center;">
  <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">추가 저장 슬롯</div>

<div id="customSaveSlots" style="display: flex; flex-direction: column; gap: 16px; align-items: center;">

  <!-- 슬롯1 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-1" type="text" placeholder="제목 입력" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(1)">📥 저장</button>
      <button onclick="loadCustomEstimate(1)">📂 확인</button>
    </div>
  </div>

  <!-- 슬롯2 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-2" type="text" placeholder="제목 입력" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(2)">📥 저장</button>
      <button onclick="loadCustomEstimate(2)">📂 확인</button>
    </div>
  </div>

  <!-- 슬롯3 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-3" type="text" placeholder="제목 입력" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(3)">📥 저장</button>
      <button onclick="loadCustomEstimate(3)">📂 확인</button>
    </div>
  </div>

  <!-- 슬롯4 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-4" type="text" placeholder="제목 입력" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(4)">📥 저장</button>
      <button onclick="loadCustomEstimate(4)">📂 확인</button>
    </div>
  </div>

  <!-- 슬롯5 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-5" type="text" placeholder="제목 입력" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(5)">📥 저장</button>
      <button onclick="loadCustomEstimate(5)">📂 확인</button>
    </div>
  </div>
</div>
<div id="summaryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; border-radius:12px; width:90%; max-width:900px; position:relative;">
    <button onclick="toggleSummaryModal()" style="position:absolute; top:10px; right:10px; font-size:24px; background:none; border:none; cursor:pointer;">✕</button>
    <h3 style="margin-top:0; text-align:center;">정리된 견적 내용</h3>
    <textarea id="modalSummaryText" style="width:100%; height:400px;"></textarea>
    <button onclick="copyModalSummaryText()" style="margin-top:10px;">복사</button>
  </div>
</div>
  </div> <!-- end of flex layout -->

  <div id="imageModal" onclick="closeModal(event)">
  <div id="imageWrapper" style="position: relative; display: inline-block;">
    <img id="modalImage" src="" />
    <!-- 닫기 버튼 추가 -->
    <button id="closeImageBtn" onclick="closeModal(event)" style="
  position: absolute;
  top: -20px;
  right: -20px;
  font-size: 30px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  z-index: 2000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  transition: background 0.3s;
" onmouseover="this.style.background='rgba(0,0,0,0.6)'" onmouseout="this.style.background='rgba(0,0,0,0.8)'">×</button>
  </div>

  <button id="prevBtn">←</button>
  <button id="nextBtn">→</button>
</div>

  <script>
  const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbxOo_V_B5LmE3f-SHWm6QunvUdl2aPvTOdOEz_wPp8KreAE6wSU9Fe22WM2rXPqgYiP/exec";
const CUSTOM_CATEGORY_ORDER = [
  "타일", "양변기(원피스)", "양변기(투피스)", "세면기", "탑볼",
  "하부장", "세면수전", "샤워기", "해바라기", "슬라이드장",
  "욕실장", "플랩장", "상 · 하단장", "거울", "슬라이드바",
  "수건걸이", "휴지걸이", "대리석", "코너선반", "스프레이건",
  "욕조", "파티션", "천장"
];
  let materials = {};
  let selected = [];
  let currentCategory = "";
  let currentSort = "";
  let isAdminMode = false;

  async function fetchMaterials() {
document.getElementById("loadingSpinner").style.display = "block";
    const res = await fetch(SHEETS_API_URL);
    const data = await res.json();
    materials = {};
    data.forEach(item => {
      if (!materials[item.category]) materials[item.category] = [];
materials[item.category].push({
  name: item.name,
  price: parseInt(item.price),
  img1: item.img1 || item.img,
  img2: item.img2 || item.img,
 isBest: item.isBest?.toString().toUpperCase() === "TRUE",
  isBasic: item.isBasic?.toString().toUpperCase() === "TRUE",
  soldOut: item.soldOut?.toString().toUpperCase() === "TRUE"
});
    });
    if (currentCategory) showItems(currentCategory);

  document.getElementById("loadingSpinner").style.display = "none";  // 스피너 숨기기
}

  function selectCategory(category) {
    currentCategory = category;
    document.getElementById('currentCategoryText').innerText = category;
    document.getElementById('addAllSetButton').style.display = (category === '세트') ? 'block' : 'none';
    showItems(category);
  }

function showItems(category) {
  const container = document.getElementById('items');
  container.innerHTML = '';

  // ✅ 메인 카테고리 전용 출력
 if (category === '메인') {
    // 👉 상단 타이틀과 정렬 숨기기
    document.querySelector('.items h3').style.display = 'none';
    document.querySelector('.sort-box').style.display = 'none';

    const items = materials[category] ? [...materials[category]] : [];
    const limitedItems = items.slice(0, 9);  // 9개까지만 제한

    const grid = document.createElement('div');
    grid.style = `
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    `;

  limitedItems.forEach(item => {
  const div = document.createElement('div');
  div.className = 'item';
  div.style.padding = '0';
  div.innerHTML = `
    <img src="${item.img1}" 
         style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px; cursor:pointer;" 
         onclick="openModal('${item.img1}', '${item.img2 || item.img1}')">
    <div class="name" style="display:none;">${item.name}</div>  <!-- 이름은 존재하지만 숨김 -->
  `;
  grid.appendChild(div);
});

    container.appendChild(grid);
    return;  // ✅ 메인일 경우 여기서 바로 종료 (나머지 코드 실행 안함)
  }

  // ✅ 다른 카테고리 진입시 다시 보이게
  document.querySelector('.items h3').style.display = 'block';
  document.querySelector('.sort-box').style.display = 'block';

  // ✅ 세트 카테고리일 때 커스텀 입력폼 추가
  if (category === '세트') {
  container.innerHTML += `
    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 10px;">
      <label>이름: <input type="text" id="customName" style="width: 120px;"></label>
      <label>금액: <input type="number" id="customPrice" style="width: 120px;"></label>
      <label>수량: <input type="number" id="customQty" value="1" min="1" style="width: 60px;"></label>
      <button onclick="addCustomSetItem()">추가</button>
    </div>
  `;
}

  let items = materials[category] ? [...materials[category]] : [];

  if (currentSort === 'name') {
    items.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
  } else if (currentSort === 'price') {
    items.sort((a, b) => a.price - b.price);
  }
  items.sort((a, b) => {
    if (a.isBest && !b.isBest) return -1;
    if (!a.isBest && b.isBest) return 1;
    return 0;
  });

    items.forEach((item, i) => {
  const div = document.createElement('div');
  const img2Safe = (item.img2 && item.img2 !== "undefined") ? item.img2 : item.img1;

  div.className = 'item';
  div.innerHTML = `
    ${item.isBest ? `<div class="best-badge">BEST</div>` : ""}
    ${item.isBasic ? `<div class="basic-badge">기본형</div>` : ""}
    <div class="soldout-wrapper" style="position: relative;">
  <img 
    src="${item.img1}" 
    data-img1="${item.img1}" 
    data-img2="${img2Safe}" 
    onclick="openModal('${item.img1}', '${img2Safe}')" 
    onmouseover="this.src=this.dataset.img2" 
    onmouseout="this.src=this.dataset.img1"
    style="${item.soldOut ? 'filter: grayscale(100%); opacity: 0.6;' : ''}"
  >
  ${item.soldOut ? `<div class="soldout-overlay">일시품절</div>` : ""}
</div>
    <div class="name">${item.name}</div>
    <div class="price">
      <span id="item-price-${i}">${item.price.toLocaleString()}원</span>
      ${isAdminMode ? `<button onclick="editItemPrice(${i})">✎</button>` : ""}
    </div>
    <div class="control">
      <input type="number" min="1" value="1" id="qty-${item.name}">
      <button onclick="addToEstimate('${category}', '${item.name}')" ${item.soldOut ? 'disabled style="opacity:0.4; cursor:not-allowed;"' : ''}>선택</button>
      ${
        selected.some(sel => sel.name === item.name)
          ? `<button onclick="removeFromEstimate('${item.name}')">취소</button>`
          : ""
      }
    </div>
<button class="detail-btn" onclick="openDetailModal('${item.name}')">상세보기</button>

${isAdminMode ? `
  <button class="admin-expand-btn" onclick="toggleAdminPanel(${i})">추가옵션</button>
  <div class="admin-options" id="admin-options-${i}" style="display: none;">
    <button class="best-btn" onclick="uploadImage2('${category}', '${item.name}')">이미지2 추가</button>
    ${item.isBest
      ? `<button class="best-btn" onclick="unmarkAsBest('${category}', '${item.name}')">BEST 삭제</button>`
      : `<button class="best-btn" onclick="markAsBest('${category}', '${item.name}')">BEST 추가</button>`}
    ${item.isBasic
      ? `<button class="best-btn" onclick="unmarkAsBasic('${category}', '${item.name}')">기본형 삭제</button>`
      : `<button class="best-btn" onclick="markAsBasic('${category}', '${item.name}')">기본형 추가</button>`}
    ${item.soldOut
      ? `<button class="best-btn" onclick="unmarkAsSoldOut('${category}', '${item.name}')">일시품절 해제</button>`
      : `<button class="best-btn" onclick="markAsSoldOut('${category}', '${item.name}')">일시품절 추가</button>`}
  </div>
` : ""}
`;
      container.appendChild(div);
    });

  updateSelectedBorders();
  }

  function sortMaterials(type) {
    currentSort = type;
    if (currentCategory) showItems(currentCategory);
  }

function toggleAdminPanel(index) {
  const panel = document.getElementById(`admin-options-${index}`);
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

  function addToEstimate(category, name) {
    const item = materials[category].find(i => i.name === name);
    const qtyInput = document.getElementById(`qty-${item.name}`);
    const qty = parseInt(qtyInput.value);

    if (isNaN(qty) || qty <= 0) {
      alert("수량을 입력하세요");
      return;
    }

    const existing = selected.find(i => i.name === item.name);
    if (existing) {
      existing.quantity += qty;
    } else {
      selected.push({ ...item, quantity: qty, category });
    }

renderEstimate();
showItems(currentCategory);
}

  function addAllFromSet() {
    const items = materials[currentCategory] || [];
    items.forEach(item => {
      selected.push({ ...item, quantity: 1, category: currentCategory });
    });
    renderEstimate();
  }
// ✅ 여기 아래에 삽입
function updateSelectedBorders() {
  document.querySelectorAll('.item').forEach(div => {
    const name = div.querySelector('.name').textContent;
    const isSelected = selected.some(item => item.name === name);
    if (isSelected) {
      div.classList.add('selected-border');
    } else {
      div.classList.remove('selected-border');
    }
  });
}

function renderEstimate() {
  const list = document.getElementById('selectedItems');
  list.innerHTML = '';

  selected.sort((a, b) => {
    const aIndex = CUSTOM_CATEGORY_ORDER.indexOf(a.category);
    const bIndex = CUSTOM_CATEGORY_ORDER.indexOf(b.category);
    if (aIndex === -1 && bIndex === -1) return 0;
    if (aIndex === -1) return 1;
    if (bIndex === -1) return -1;
    return aIndex - bIndex;
  });

  selected.forEach((item, i) => {
  // ✅ 특정 카테고리는 관리자 모드일 때만 표시
  const hiddenCategories = ["타일", "시공비", "별도 시공비"];
  if (!isAdminMode && hiddenCategories.includes(item.category)) {
    return;  // 일반 사용자일 경우 해당 항목 건너뜀
  }

  const nameOnly = item.name.split("(")[0];
  const code = item.name.match(/\((.*?)\)/)?.[1] || '';
  list.innerHTML += `
    <li class="estimate-item">
      <img src="${item.img1}" onclick="openModal('${item.img1}', '${item.img2}')">
      <div class="info-line">
        <div>${nameOnly}</div>
        <div>${code} x ${item.quantity}</div>
      </div>
      <div class="price-delete">
        <span ${!isAdminMode ? 'style="display:none;"' : ''}>
          ${(item.price * item.quantity).toLocaleString()}원
        </span>
        <button class="delete-btn" onclick="removeItem(${i})">✕</button>
      </div>
    </li>
  `;
});

  updateSelectedBorders();
  updateTotal();
  updateCategoryTexts();
}

  function updateTotal() {
  const total = selected.reduce((sum, i) => sum + i.price * i.quantity, 0);
  const totalPriceSpan = document.getElementById('totalPrice');
  const totalWrapper = document.getElementById('totalWrapper');

  if (isAdminMode) {
    totalPriceSpan.textContent = total.toLocaleString();
    totalWrapper.style.display = "block";
  } else {
    totalPriceSpan.textContent = "";
    totalWrapper.style.display = "none";
  }
}

  function summarizeEstimate() {
  const countMap = {};
  selected.forEach(item => {
    if (item.category === "시공비" || item.category === "별도 시공비" || item.category === "철거") return;
    if (!countMap[item.name]) countMap[item.name] = 0;
    countMap[item.name] += item.quantity;
  });
    const summaryParts = Object.entries(countMap).map(([name, qty]) =>
      qty > 1 ? `${name} ${qty}EA` : name
    );
    summaryParts.push("다운라이트 2EA");
    document.getElementById("summaryText").value = summaryParts.join(", ");
  }

  function removeItem(index) {
  selected.splice(index, 1);
  renderEstimate();
  showItems(currentCategory);
}

function removeFromEstimate(name) {
  selected = selected.filter(item => item.name !== name);
  renderEstimate();
  updateSelectedBorders();
  showItems(currentCategory);
}

  function toggleAdmin() {
  const pw = prompt("관리자 비밀번호를 입력하세요:");
  if (pw === "1760") {
    isAdminMode = true;
    document.getElementById('adminPanel').style.display = 'block';
document.getElementById("setCategoryLi").style.display = "list-item";

    // 자재 목록 즉시 반영
    if (currentCategory) showItems(currentCategory);

    // ✅ 견적서도 즉시 다시 렌더링
    renderEstimate();
  } else {
    alert("비밀번호가 틀렸습니다.");
  }
}

  function closeAdmin() {
  isAdminMode = false;
  document.getElementById('adminPanel').style.display = 'none';
document.getElementById("setCategoryLi").style.display = "none";

  // 자재 목록 일반 모드로 갱신
  if (currentCategory) showItems(currentCategory);

  // ✅ 견적서도 즉시 일반 모드로 갱신
  renderEstimate();
}

function editItemPrice(index) {
  const span = document.getElementById(`item-price-${index}`);
  const name = span.closest('.item').querySelector('.name').textContent;
  span.innerHTML = `
    <input type="number" id="new-price-${index}" value="" style="width:70px">
    <button onclick="saveItemPrice('${name}', ${index})">저장</button>
  `;

  const item = findItemByName(currentCategory, name);
  if (item) {
    document.getElementById(`new-price-${index}`).value = item.price;
  }
}

function saveItemPrice(name, index) {
  const input = document.getElementById(`new-price-${index}`);
  const newPrice = parseInt(input.value);
  const item = findItemByName(currentCategory, name);

  if (!isNaN(newPrice) && newPrice >= 0 && item) {
    item.price = newPrice;

    fetch(SHEETS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        category: currentCategory,
        name: item.name,
        price: newPrice,
        img1: item.img1,
        img2: item.img2
      }),
      mode: "no-cors"
    })
    .then(() => {
      alert("가격이 수정 요청되었습니다!");
      fetchMaterials();
    })
    .catch(() => {
      alert("가격 수정 실패!");
    });

    showItems(currentCategory);
  } else {
    alert("올바른 가격을 입력해주세요.");
  }
}

function findItemByName(category, name) {
  return (materials[category] || []).find(i => i.name === name);
}

  function addMaterial() {
    const name = document.getElementById("adminName").value;
    const price = parseInt(document.getElementById("adminPrice").value);
    const file1 = document.getElementById("adminImgFile1").files[0];
    const file2 = document.getElementById("adminImgFile2").files[0];

    if (!name || isNaN(price) || price < 0 || !file1 || !currentCategory) {
  alert("필수 항목을 모두 입력해주세요! (가격은 0 이상이어야 합니다)");
  return;
}

    const reader1 = new FileReader();
    const reader2 = new FileReader();

    reader1.onload = function (e1) {
      const img1 = e1.target.result;

      if (!file2) {
        const img2 = img1;
        submitMaterial(img1, img2);
      } else {
        reader2.onload = function (e2) {
          const img2 = e2.target.result;
          submitMaterial(img1, img2);
        };
        reader2.readAsDataURL(file2);
      }
    };
    reader1.readAsDataURL(file1);
  }

  function submitMaterial(img1, img2) {
    const name = document.getElementById("adminName").value;
    const price = parseInt(document.getElementById("adminPrice").value);

    fetch(SHEETS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category: currentCategory, name, price, img1, img2 }),
      mode: "no-cors"
    }).then(() => {
      alert("자재가 성공적으로 추가되었습니다!");
      document.getElementById("adminName").value = "";
      document.getElementById("adminPrice").value = "";
      document.getElementById("adminImgFile1").value = "";
      document.getElementById("adminImgFile2").value = "";
      fetchMaterials().then(() => showItems(currentCategory));
    });
  }

  function closeModal(event) {
    if (event.target.id === 'imageModal' || event.target.tagName === 'BUTTON') {
      document.getElementById('imageModal').style.display = 'none';
      document.getElementById('modalImage').src = '';
    modalImages = [];
    modalIndex = 0;
    }
  }

let modalImages = [];
let modalIndex = 0;

window.onload = function() {
  const panel = document.getElementById("itemsPanel");
  panel.classList.remove("show");
 document.getElementById("setCategoryLi").style.display = "none";

Promise.all([
  fetchMaterials(),
  fetch(`${SHEETS_API_URL}?type=get_all_titles`)
    .then(res => res.json())
    .then(titles => {
      const sortedSlots = Object.entries(titles)
        .sort((a, b) => {
          const timeA = new Date(a[1].lastLoaded).getTime();
          const timeB = new Date(b[1].lastLoaded).getTime();
          return timeB - timeA;
        })
        .map(entry => entry[0]);  // 여기 parseInt 제거 (문자열 유지)

      const container = document.getElementById("customSaveSlots");
      container.innerHTML = "";

      sortedSlots.forEach(slot => {
        const slotNum = parseInt(slot);  // 문자열 → 숫자 변환
        if (slotNum < 100) return;       // 1,2,3번 건너뜀

        const simpleSlot = slotNum - 100;
        const titleValue = titles[slot]?.title || "";

        const block = document.createElement("div");
        block.style = "display: flex; flex-direction: column; gap: 6px; align-items: center;";
        block.innerHTML = `
          <input id="customTitle-${simpleSlot}" type="text" value="${titleValue}" placeholder="제목 입력" style="width: 160px; padding: 6px;">
          <div style="display:flex; gap: 8px; margin-bottom: 10px;">
            <button onclick="saveCustomEstimate(${simpleSlot})">📥 저장</button>
            <button onclick="loadCustomEstimate(${simpleSlot})">📂 확인</button>
          </div>
        `;
        container.appendChild(block);
      });
    }),
fetch(`${SHEETS_API_URL}?type=load_all_details`)
      .then(res => res.json())
      .then(data => {
        detailData = data; // ✅ 여기에 저장
      })
  ]).then(() => {
    selectCategory('메인');
    setTimeout(() => {
      panel.classList.add("show");
    }, 100);
  });

  history.pushState(null, null, location.href);
  window.addEventListener('popstate', function(event) {
      history.pushState(null, null, location.href);
  });
}

  function openModal(img1, img2) {
    if (!img2 || img2 === "undefined") img2 = img1;
    modalImages = [img1, img2];
    modalIndex = 0;
    showModalImage();
    document.getElementById('imageModal').style.display = 'flex';
// 화살표 클릭 이벤트 연결
  document.getElementById('prevBtn').onclick = (e) => {
    e.stopPropagation();
    modalIndex = (modalIndex - 1 + modalImages.length) % modalImages.length;
    showModalImage();
  };

  document.getElementById('nextBtn').onclick = (e) => {
    e.stopPropagation();
    modalIndex = (modalIndex + 1) % modalImages.length;
    showModalImage();
  };
  }

  function showModalImage() {
    document.getElementById('modalImage').src = modalImages[modalIndex];
  }

function markAsBest(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBest = true; // 로컬 상태 먼저 반영

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBest: true // Google Sheet에 TRUE로 저장
    }),
    mode: "no-cors"
  }).then(() => {
    alert("BEST로 등록되었습니다!");
    fetchMaterials().then(() => showItems(currentCategory)); // 최신 데이터 반영
  });
}
function unmarkAsBest(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBest = false;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBest: false
    }),
    mode: "no-cors"
  }).then(() => {
    alert("BEST가 해제되었습니다!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}
function markAsBasic(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBasic = true;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBasic: true
    }),
    mode: "no-cors"
  }).then(() => {
    alert("기본형으로 등록되었습니다!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}

function unmarkAsBasic(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBasic = false;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBasic: false
    }),
    mode: "no-cors"
  }).then(() => {
    alert("기본형이 해제되었습니다!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}
function clearEstimate() {
  if (confirm("견적 항목을 모두 삭제하시겠습니까?")) {
    selected = [];
    renderEstimate();
    document.getElementById("summaryText").value = "";
    updateEstimateTitle("견적서");
  }
}

function copySummaryText() {
  const textarea = document.getElementById("summaryText");
  textarea.select();
  textarea.setSelectionRange(0, 99999); // 모바일 대응
  navigator.clipboard.writeText(textarea.value)
    .then(() => alert("복사되었습니다!"))
    .catch(() => alert("복사에 실패했습니다."));
}

function loadSavedEstimate(slot) {
  if (!confirm("저장된 견적을 불러오시겠습니까?")) {
    return;
  }

  document.getElementById("loadingSpinner").style.display = "block";

  fetch(`${SHEETS_API_URL}?slot=${slot}`)
    .then(res => res.json())
    .then(data => {
      selected = data.map(item => ({
        name: item.name,
        price: parseInt(item.price),
        quantity: parseInt(item.quantity),
        category: item.category,
        img1: item.img1,
        img2: item.img2
      }));

      renderEstimate();

      const estimateTitleEl = document.getElementById("estimateTitle");
      if (estimateTitleEl) {
        estimateTitleEl.textContent = slot === 1 ? "거실" : slot === 2 ? "안방" : slot === 3 ? "세트" : "견적서";
      }

      alert(`저장${slot}번 견적을 불러왔습니다.`);
    })
    .catch(err => {
      alert("견적 불러오기 실패: " + err);
    })
    .finally(() => {
      document.getElementById("loadingSpinner").style.display = "none";
    });
}

function saveEstimate(slot) {
  if (selected.length === 0) {
    alert("저장할 견적이 없습니다.");
    return;
  }

  if (!confirm("저장하시겠습니까?")) {
    return;  // 취소 시 아무것도 안함
  }

  const payload = selected.map(item => ({
    slot,
    name: item.name,
    price: item.price,
    quantity: item.quantity,
    category: item.category,
    img1: item.img1,
    img2: item.img2
  }));

document.getElementById("loadingSpinner").style.display = "block";

   fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "save", data: payload }),
    mode: "no-cors"
  }).then(() => {
    alert(`저장${slot}번으로 저장되었습니다!`);
  }).catch(() => {
    alert("저장에 실패했습니다.");
  }).finally(() => {
    document.getElementById("loadingSpinner").style.display = "none";
  });
}
function updateEstimateTitle(text) {
  document.getElementById("estimateTitle").textContent = text;
}
function toggleSummaryModal() {
  const modal = document.getElementById("summaryModal");
  const textarea = document.getElementById("summaryText");
  const modalTextarea = document.getElementById("modalSummaryText");

  modalTextarea.value = textarea.value; // 기존 요약내용 복사
  modal.style.display = modal.style.display === "flex" ? "none" : "flex";
}

function copyModalSummaryText() {
  const textarea = document.getElementById("modalSummaryText");
  textarea.select();
  document.execCommand("copy");
  alert("복사되었습니다!");
}

function updateCategoryTexts() {
  const selectedCategories = selected.map(i => i.category);
  const includesAll = (arr) => arr.every(c => selectedCategories.includes(c));

  const highlight = (id, condition) => {
    const el = document.getElementById(`text-${id}`);
    if (el) {
      el.style.color = condition ? 'red' : 'inherit';
      el.style.fontWeight = condition ? 'bold' : 'normal';
    }
  };

  highlight("타일", selectedCategories.includes("타일"));
  highlight("양변기", selectedCategories.includes("양변기(원피스)") || selectedCategories.includes("양변기(투피스)"));
  highlight("세면기", selectedCategories.includes("세면기") || selectedCategories.includes("탑볼") || selectedCategories.includes("하부장"));
  highlight("세면수전", selectedCategories.includes("세면수전"));
  highlight("샤워기", selectedCategories.includes("샤워기") || selectedCategories.includes("해바라기"));

  const chk1 = selectedCategories.includes("슬라이드장");
  const chk2 = includesAll(["욕실장", "거울"]);
  const chk3 = includesAll(["상 · 하단장", "거울"]);
  highlight("욕실장", chk1 || chk2 || chk3);

  highlight("슬라이드바", selectedCategories.includes("슬라이드바"));
  highlight("수건걸이", selectedCategories.includes("수건걸이"));
  highlight("휴지걸이", selectedCategories.includes("휴지걸이"));
  highlight("대리석", selectedCategories.includes("대리석"));
  highlight("코너선반", selectedCategories.includes("코너선반"));
  highlight("천장", selectedCategories.includes("천장"));
  highlight("욕조", selectedCategories.includes("욕조"));
  highlight("파티션", selectedCategories.includes("파티션"));
}

function addCustomSetItem() {
  const name = document.getElementById('customName').value.trim();
  const price = parseInt(document.getElementById('customPrice').value);
  const qty = parseInt(document.getElementById('customQty').value);

  if (!name || isNaN(price) || isNaN(qty) || qty <= 0) {
    alert("이름, 금액, 수량을 정확히 입력하세요.");
    return;
  }

  // 입력한 이름에서 () 앞부분만 추출
  const baseName = name.split("(")[0].trim();

  // selected 배열에서 동일 baseName 찾기
  const existing = selected.find(item => {
    const existingBaseName = item.name.split("(")[0].trim();
    return existingBaseName === baseName;
  });

  if (existing) {
    // 금액만 누적
    existing.price += price;
  } else {
    // 새로 추가
    selected.push({
      name: name,
      price: price,
      quantity: qty,
      category: '세트',
      img1: '',  
      img2: ''
    });
  }

  renderEstimate();
  document.getElementById('customName').value = '';
  document.getElementById('customPrice').value = '';
  document.getElementById('customQty').value = '1';
}

// 🔧 새로운 8개 저장 슬롯은 slot번호를 101~108로 관리합니다.
function saveCustomEstimate(slotNumber) {
  if (selected.length === 0) {
    alert("저장할 견적이 없습니다.");
    return;
  }

  const titleInput = document.getElementById(`customTitle-${slotNumber}`);
  const title = titleInput.value.trim();

  if (!title) {
    alert("제목을 입력해주세요.");
    return;
  }

  if (!confirm(`"${title}" 로 저장하시겠습니까?`)) {
    return;
  }

  const payload = selected.map(item => ({
    slot: 100 + slotNumber,
    name: item.name,
    price: item.price,
    quantity: item.quantity,
    category: item.category,
    img1: item.img1,
    img2: item.img2
  }));

  document.getElementById("loadingSpinner").style.display = "block";

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "save_custom", data: payload, title: title }),
    mode: "no-cors"
  }).then(() => {
    alert(`${title} 으로 저장되었습니다!`);
  }).catch(() => {
    alert("저장에 실패했습니다.");
  }).finally(() => {
    document.getElementById("loadingSpinner").style.display = "none";
  });
}

function loadCustomEstimate(slotNumber) {
  if (!confirm("저장된 견적을 불러오시겠습니까?")) {
    return;
  }

  document.getElementById("loadingSpinner").style.display = "block";

  fetch(`${SHEETS_API_URL}?type=load_custom&slot=${100 + slotNumber}`)
    .then(res => res.json())
    .then(data => {
      if (!data || !data.items || data.items.length === 0) {
        alert("저장된 데이터가 없습니다.");
        return;
      }

      selected = data.items.map(item => ({
        name: item.name,
        price: parseInt(item.price),
        quantity: parseInt(item.quantity),
        category: item.category,
        img1: item.img1,
        img2: item.img2
      }));

      renderEstimate();

      const titleElement = document.getElementById(`customTitle-${slotNumber}`);
      if (titleElement) {
        titleElement.value = data.title || "";
      }

      const estimateTitleEl = document.getElementById("estimateTitle");
      if (estimateTitleEl) {
        estimateTitleEl.textContent = data.title || "견적서";
      }

      fetch(SHEETS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type: "update_last_loaded", slot: 100 + slotNumber }),
        mode: "no-cors"
      }).then(() => {
        reloadSaveSlots();
      });

      alert(`"${data.title}" 견적을 불러왔습니다.`);
    })
    .catch(err => {
      alert("불러오기 실패: " + err);
    })
    .finally(() => {
      document.getElementById("loadingSpinner").style.display = "none";
    });
}

function reloadSaveSlots() {
  fetch(`${SHEETS_API_URL}?type=get_all_titles`)
    .then(res => res.json())
    .then(titles => {
      const sortedSlots = Object.entries(titles)
        .sort((a, b) => new Date(b[1].lastLoaded) - new Date(a[1].lastLoaded))
        .map(entry => entry[0]);  // 👉 여기서는 parseInt 하지마 (문자열 유지)

      const container = document.getElementById("customSaveSlots");
      container.innerHTML = "";

      sortedSlots.forEach(slot => {
        const slotNum = parseInt(slot);  // ✅ 문자열 → 숫자 변환 정확히 여기서 함
        if (slotNum < 100) return;       // ✅ 1,2,3번은 표시 안함 (거실, 안방, 세트 제외)

        const simpleSlot = slotNum - 100;
        const titleValue = titles[slot]?.title || "";

        const block = document.createElement("div");
        block.style = "display: flex; flex-direction: column; gap: 6px; align-items: center;";
        block.innerHTML = `
          <input id="customTitle-${simpleSlot}" type="text" value="${titleValue}" placeholder="제목 입력" style="width: 160px; padding: 6px;">
          <div style="display:flex; gap: 8px; margin-bottom: 10px;">
            <button onclick="saveCustomEstimate(${simpleSlot})">📥 저장</button>
            <button onclick="loadCustomEstimate(${simpleSlot})">📂 확인</button>
          </div>
        `;
        container.appendChild(block);
      });
    })
    .catch(err => {
      console.error("타이틀 재로드 실패", err);
    });
}

let detailData = {};
let currentDetailName = "";

function openDetailModal(name) {
  currentDetailName = name;
  document.getElementById("detailItemName").textContent = name;
  document.getElementById("detailTextArea").value = detailData[name] || "";
  document.getElementById("detailModal").style.display = "flex";
}

function closeDetailModal() {
  document.getElementById("detailModal").style.display = "none";
  currentDetailName = "";
}

function saveDetail() {
  const detail = document.getElementById("detailTextArea").value.trim();
  if (!currentDetailName) return;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: "save_detail",
      name: currentDetailName,
      detail: detail
    }),
    mode: "no-cors"
  }).then(() => {
    alert("상세정보가 저장되었습니다.");
    detailData[currentDetailName] = detail;
    closeDetailModal();
  }).catch(() => {
    alert("저장 실패");
  });
}

function uploadImage2(category, name) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const img2 = reader.result;

      const item = materials[category].find(i => i.name === name);
      if (!item) return;

      fetch(SHEETS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
type: "update_image2",
          category,
          name,
          price: item.price,
          img1: item.img1,
          img2: img2  // ✅ 이미지2만 갱신
        }),
        mode: "no-cors"
      }).then(() => {
        alert("이미지2가 추가되었습니다!");
        fetchMaterials().then(() => showItems(currentCategory));
      }).catch(() => {
        alert("이미지2 추가 실패");
      });
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function markAsSoldOut(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.soldOut = true;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      soldOut: true
    }),
    mode: "no-cors"
  }).then(() => {
    alert("일시품절로 표시되었습니다!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}

function unmarkAsSoldOut(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.soldOut = false;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      soldOut: false
    }),
    mode: "no-cors"
  }).then(() => {
    alert("일시품절 해제되었습니다!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}
  </script>

  <div class="admin" id="adminPanel">
    <h3>🔧 관리자 모드</h3>
    <label>현재 카테고리: <span id="currentCategoryText">-</span></label>
    <label>자재 이름: <input type="text" id="adminName" /></label>
    <label>가격: <input type="number" id="adminPrice" /></label>
    <label>이미지 1: <input type="file" id="adminImgFile1" accept="image/*" /></label>
    <label>이미지 2: <input type="file" id="adminImgFile2" accept="image/*" /></label>
    <button onclick="addMaterial()">자재 추가하기</button>
    <button onclick="closeAdmin()">관리자 모드 닫기</button>
  </div>

<div id="loadingSpinner" style="
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.8);
  padding: 40px 60px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 9999;
  display: none;
">
  <div style="display: flex; flex-direction: column; align-items: center;">
    <div class="spinner" style="
      width: 50px; height: 50px;
      border: 5px solid #ccc;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    "></div>
    <div style="font-size: 20px;">로딩중...</div>
  </div>
</div>

<div id="detailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; border-radius:12px; width:90%; max-width:600px; position:relative;">
    <button onclick="closeDetailModal()" style="position:absolute; top:10px; right:10px; font-size:24px; background:none; border:none; cursor:pointer;">✕</button>
    <h3 style="margin-top:0; text-align:center;">상세정보 입력</h3>
    <div style="margin-bottom: 10px;"><strong id="detailItemName"></strong></div>
    <textarea id="detailTextArea" style="width:100%; height:200px;"></textarea>
    <button onclick="saveDetail()" style="margin-top:10px;">저장</button>
  </div>
</div>
</body>
</html>
