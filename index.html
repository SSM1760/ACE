

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìš•ì‹¤ ê²¬ì ì„œ í”„ë¡œê·¸ë¨</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
    }

    .category, .estimate, .items {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .category {
      flex: 0 0 220px;
      max-height: 100vh;
      overflow-y: auto;
      position: sticky;
      top: 20px;
    }

    .items {
      flex: 1 1 700px;
      max-width: 1000px;
    }

    .estimate {
  flex: 0 0 280px;
}

    h3 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 12px;
    }

    .main-category {
      font-size: 15px;
      color: #222;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
      margin-top: 20px;
    }

    .sub-category {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 0;
  margin: 10px 0 20px 0;
}

.sub-category li {
  font-size: 13px;
  color: #0077cc;
  padding: 4px 10px;
  background: #f0f8ff;
  border-radius: 5px;
  cursor: pointer;
  list-style: none;
  white-space: nowrap;
  transition: background 0.2s;
}

.sub-category li:hover {
  background: #dcefff;
  text-decoration: underline;
}

    .items #items {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

    .item {
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 16px;
      background: #fff;
      text-align: center;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s;
position: relative;
z-index: 0;
    }

.item.selected-border {
  border: 2px solid red !important;
}

    .item:hover {
      transform: translateY(-3px);
    }

    .item img {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 12px;
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .item .name {
      font-weight: bold;
      font-size: 15px;
      margin-top: 4px;
      color: #222;
    }

    .item .price {
      font-size: 14px;
      color: #666;
    }

    .item .control {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }

    .item .control input[type="number"] {
      width: 48px;
      height: 36px;
      font-size: 14px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .item .control button {
      height: 40px;
      padding: 0 14px;
      font-size: 15px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    .sort-box {
      text-align: right;
      margin-bottom: 10px;
    }

    .estimate ul {
      list-style: none;
      padding-left: 0;
    }

    .estimate-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .estimate-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 10px;
    }

    .estimate-item .info-line {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .estimate-item .info-line div:first-child {
      font-weight: bold;
      font-size: 15px;
    }

    .estimate-item .info-line div:last-child {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .price-delete {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .price-delete span {
      font-weight: bold;
      white-space: nowrap;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }

    .delete-btn:hover {
      color: red;
    }

    .admin {
      display: none;
      background-color: #f9f9f9;
      width: 90%;
      margin: 30px auto 0;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    #totalWrapper {
      display: none;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    button {
      margin-top: 10px;
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      color: #333;
      font-size: 15px;
      border-radius: 5px;
      padding: 8px 16px;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #e0e0e0;
    }

    textarea {
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      font-family: inherit;
      resize: none;
    }
#modalSummaryText {
  font-size: 26px !important;
  line-height: 1.6;
}

    #imageModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #imageModal img {
      max-width: 700px;
      max-height: 700px;
      width: 100%;
      height: auto;
      border: 5px solid #fff;
      border-radius: 10px;
    }

    #imageModal button {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 24px;
      background: none;
      color: white;
      border: none;
      cursor: pointer;
    }

#prevBtn, #nextBtn {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  font-size: 60px;
  color: white;
  background: none;
  border: none;
  cursor: pointer;
  z-index: 1001;
  padding: 0;
  margin: 0;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#prevBtn {
  left: 10px;
}

#nextBtn {
  right: 10px;
}
.best-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: orange;
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
z-index: 5;
}

.basic-badge {
  position: absolute;
  top: 8px;
  left: 56px; /* BEST ë°°ì§€ ì˜¤ë¥¸ìª½ */
  background: #3ca7ff; /* ì°¨ë¶„í•œ íŒŒë€ìƒ‰ */
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
z-index: 5;
}

.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.detail-btn {
  margin-top: 8px;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(6px);
  border: 1px solid #ddd;
  border-radius: 8px;
  color: #333;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.detail-btn:hover {
  background: rgba(240,240,240,0.8);
  border-color: #bbb;
}

.soldout-wrapper {
  position: relative;
}

.soldout-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(220, 220, 220, 0.4); /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
  display: flex;
  justify-content: center;
  align-items: center;
  color: #333;
  font-weight: bold;
  font-size: 1.2em;
  border-radius: 8px;
  z-index: 4;
}

@media (max-width: 1100px) {
  body > div {
    flex-direction: column;
    padding: 10px;
  }

.estimate-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

.estimate-buttons button {
  width: 100%;
}

  .category, .items, .estimate {
    width: 100% !important;
    max-width: 100%;
  }

  .category {
    order: 1;
  }

  .items {
    order: 2;
  }

  .estimate {
    order: 3;
    margin-top: 10px;
  }

  .items #items {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .item {
    font-size: 15px;
  }

  .item .control button {
    padding: 0 12px;
  }

  .item .control input[type="number"] {
    width: 40px;
  }

  .estimate {
    position: relative;
    top: auto;
  }

.estimate-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 12px;
}

.estimate-buttons-row {
  display: flex;
  gap: 10px;
}

.estimate-buttons button {
  flex: 1;
  white-space: nowrap;
  padding: 8px 12px;
  font-size: 14px;
}

#itemsPanel {
  opacity: 0;
  transition: opacity 0.5s ease;
}
#itemsPanel.show {
  opacity: 1;
}
.detail-btn {
  margin-top: 6px;
  background-color: #f7f9fb;
  border: 1px solid #ccd8e0;
  color: #333;
  font-size: 14px;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.detail-btn:hover {
  background-color: #e6eff7;
  border-color: #a8c4d9;
  color: #0077cc;
}
  </style>

</head>
<body>
  <div style="display: flex; gap: 20px; padding: 20px;">
    <div class="category">
      <h3>ìì¬ ì¹´í…Œê³ ë¦¬</h3>
      <button onclick="toggleAdmin()">ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ</button>
      <hr />
      <div class="main-category">ì¥ Â· ê±°ìš¸</div>
      <ul class="sub-category">
        <li onclick="selectCategory('ìƒ Â· í•˜ë‹¨ì¥')">ìƒ Â· í•˜ë‹¨ì¥</li>
        <li onclick="selectCategory('ìš•ì‹¤ì¥')">ìš•ì‹¤ì¥</li>
        <li onclick="selectCategory('ìŠ¬ë¼ì´ë“œì¥')">ìŠ¬ë¼ì´ë“œì¥</li>
        <li onclick="selectCategory('í”Œë©ì¥')">í”Œë©ì¥</li>
        <li onclick="selectCategory('ê±°ìš¸')">ê±°ìš¸</li>
        <li onclick="selectCategory('í•˜ë¶€ì¥')">í•˜ë¶€ì¥</li>
      </ul>

      <div class="main-category">ë„ê¸°</div>
      <ul class="sub-category">
        <li onclick="selectCategory('ì„¸ë©´ê¸°')">ì„¸ë©´ê¸°</li>
        <li onclick="selectCategory('ì–‘ë³€ê¸°(ì›í”¼ìŠ¤)')">ì–‘ë³€ê¸°(ì›í”¼ìŠ¤)</li>
        <li onclick="selectCategory('ì–‘ë³€ê¸°(íˆ¬í”¼ìŠ¤)')">ì–‘ë³€ê¸°(íˆ¬í”¼ìŠ¤)</li>
        <li onclick="selectCategory('íƒ‘ë³¼')">íƒ‘ë³¼</li>
      </ul>

      <div class="main-category">ìˆ˜ì „</div>
      <ul class="sub-category">
        <li onclick="selectCategory('ì„¸ë©´ìˆ˜ì „')">ì„¸ë©´ìˆ˜ì „</li>
        <li onclick="selectCategory('ìƒ¤ì›Œê¸°')">ìƒ¤ì›Œê¸°</li>
        <li onclick="selectCategory('í•´ë°”ë¼ê¸°')">í•´ë°”ë¼ê¸°</li>
        <li onclick="selectCategory('íƒ‘ë³¼ìˆ˜ì „')">íƒ‘ë³¼ìˆ˜ì „</li>
      </ul>

      <div class="main-category">ì•…ì„¸ì‚¬ë¦¬</div>
<ul class="sub-category">
  <li onclick="selectCategory('ìˆ˜ê±´ê±¸ì´')">ìˆ˜ê±´ê±¸ì´</li>
  <li onclick="selectCategory('ìŠ¬ë¼ì´ë“œë°”')">ìŠ¬ë¼ì´ë“œë°”</li>
  <li onclick="selectCategory('íœ´ì§€ê±¸ì´')">íœ´ì§€ê±¸ì´</li>
  <li onclick="selectCategory('ì½”ë„ˆì„ ë°˜')">ì½”ë„ˆì„ ë°˜</li>
  <li onclick="selectCategory('ëŒ€ë¦¬ì„')">ëŒ€ë¦¬ì„</li>
  <li onclick="selectCategory('ìŠ¤í”„ë ˆì´ê±´')">ìŠ¤í”„ë ˆì´ê±´</li>
</ul>

<div class="main-category">ê¸°íƒ€</div>
<ul class="sub-category">
  <li onclick="selectCategory('íƒ€ì¼')">íƒ€ì¼</li>
  <li onclick="selectCategory('ìš•ì¡°')">ìš•ì¡°</li>
  <li onclick="selectCategory('íŒŒí‹°ì…˜')">íŒŒí‹°ì…˜</li>
  <li onclick="selectCategory('ì²œì¥')">ì²œì¥</li>
</ul>

<hr style="margin: 10px 0;" />

<ul class="sub-category">
<li onclick="selectCategory('ì² ê±°')">ì² ê±°</li>
  <li onclick="selectCategory('ì‹œê³µë¹„')">ì‹œê³µë¹„</li>
  <li onclick="selectCategory('ë³„ë„ ì‹œê³µë¹„')">ë³„ë„ ì‹œê³µë¹„</li>
</ul>

<hr style="margin: 10px 0;" />

<ul class="sub-category">
  <li onclick="selectCategory('ì„¸íŠ¸')" id="setCategoryLi">ë³„ë„ê¸ˆì•¡</li>
 <li onclick="selectCategory('ë©”ì¸')">ë©”ì¸</li>
</ul>

    </div>

    <div class="items fade-in" id="itemsPanel">
      <h3>ìì¬ ëª©ë¡</h3>
      <div class="sort-box">
        ì •ë ¬:
        <select onchange="sortMaterials(this.value)">
          <option value="">ê¸°ë³¸ìˆœ</option>
          <option value="name">ì´ë¦„ìˆœ</option>
          <option value="price">ê°€ê²©ìˆœ</option>
        </select>
      </div>
      <div id="addAllSetButton" style="display:none; text-align:right; margin-bottom:10px;">
        <button onclick="addAllFromSet()">ëª¨ë‘ ì¶”ê°€</button>
      </div>
      <div id="items"></div>
    </div>

    <div class="estimate">
      <h3 id="estimateTitle">ê²¬ì ì„œ</h3>
      <ul id="selectedItems"></ul>
      <p id="totalWrapper"><strong>ì´ì•¡: </strong><span id="totalPrice">0</span>ì›</p>
      <button onclick="summarizeEstimate()">ì •ë¦¬</button>
<button onclick="clearEstimate()" style="margin-left: 10px;">ì „ì²´ ì‚­ì œ</button>

      <textarea id="summaryText" style="width:100%; height:100px; margin-top:10px;"></textarea>
<button onclick="copySummaryText()" style="margin-top: 8px;">ë³µì‚¬</button>
<button onclick="toggleSummaryModal()" style="margin-top: 8px;">í™•ëŒ€</button>
<div class="estimate-buttons">
  <div class="estimate-buttons-row">
<button onclick="saveEstimate(1); updateEstimateTitle('ê±°ì‹¤')">ğŸ“¥ ì €ì¥(ê±°ì‹¤)</button>
<button onclick="saveEstimate(2); updateEstimateTitle('ì•ˆë°©')">ğŸ“¥ ì €ì¥(ì•ˆë°©)</button>
  </div>
  <div class="estimate-buttons-row">
    <button onclick="loadSavedEstimate(1)">ğŸ“‚ í™•ì¸(ê±°ì‹¤)</button>
    <button onclick="loadSavedEstimate(2)">ğŸ“‚ í™•ì¸(ì•ˆë°©)</button>
  </div>
  <!-- âœ… ì„¸íŠ¸ ë²„íŠ¼ ì¶”ê°€ -->
  <div class="estimate-buttons-row" style="margin-top: 24px;">
  <button onclick="saveEstimate(3); updateEstimateTitle('ì„¸íŠ¸')">ğŸ“¥ ì €ì¥(ì„¸íŠ¸)</button>
  <button onclick="loadSavedEstimate(3)">ğŸ“‚ í™•ì¸(ì„¸íŠ¸)</button>
</div>

<!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œëª©ê³¼ í•­ëª©ì„ ìƒˆ ë¸”ë¡ìœ¼ë¡œ ë¶„ë¦¬ -->
<div style="margin-top: 40px; text-align: center;">
  <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
  <div id="categoryTextGroup" style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 14px; justify-content: center;">
    <span id="text-íƒ€ì¼">íƒ€ì¼</span>
    <span id="text-ì–‘ë³€ê¸°">ì–‘ë³€ê¸°</span>
    <span id="text-ì„¸ë©´ê¸°">ì„¸ë©´ê¸°</span>
    <span id="text-ì„¸ë©´ìˆ˜ì „">ì„¸ë©´ìˆ˜ì „</span>
    <span id="text-ìƒ¤ì›Œê¸°">ìƒ¤ì›Œê¸°</span>
    <span id="text-ìš•ì‹¤ì¥">ìš•ì‹¤ì¥</span>
    <span id="text-ìŠ¬ë¼ì´ë“œë°”">ìŠ¬ë¼ì´ë“œë°”</span>
    <span id="text-ìˆ˜ê±´ê±¸ì´">ìˆ˜ê±´ê±¸ì´</span>
    <span id="text-íœ´ì§€ê±¸ì´">íœ´ì§€ê±¸ì´</span>
    <span id="text-ëŒ€ë¦¬ì„">ëŒ€ë¦¬ì„</span>
    <span id="text-ì½”ë„ˆì„ ë°˜">ì½”ë„ˆì„ ë°˜</span>
    <span id="text-ì²œì¥">ì²œì¥</span>
    <span id="text-ìš•ì¡°">ìš•ì¡°</span>
    <span id="text-íŒŒí‹°ì…˜">íŒŒí‹°ì…˜</span>
  </div>
</div>

<div style="margin-top: 40px; text-align: center;">
  <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ì¶”ê°€ ì €ì¥ ìŠ¬ë¡¯</div>

<div id="customSaveSlots" style="display: flex; flex-direction: column; gap: 16px; align-items: center;">

  <!-- ìŠ¬ë¡¯1 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-1" type="text" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(1)">ğŸ“¥ ì €ì¥</button>
      <button onclick="loadCustomEstimate(1)">ğŸ“‚ í™•ì¸</button>
    </div>
  </div>

  <!-- ìŠ¬ë¡¯2 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-2" type="text" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(2)">ğŸ“¥ ì €ì¥</button>
      <button onclick="loadCustomEstimate(2)">ğŸ“‚ í™•ì¸</button>
    </div>
  </div>

  <!-- ìŠ¬ë¡¯3 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-3" type="text" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(3)">ğŸ“¥ ì €ì¥</button>
      <button onclick="loadCustomEstimate(3)">ğŸ“‚ í™•ì¸</button>
    </div>
  </div>

  <!-- ìŠ¬ë¡¯4 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-4" type="text" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(4)">ğŸ“¥ ì €ì¥</button>
      <button onclick="loadCustomEstimate(4)">ğŸ“‚ í™•ì¸</button>
    </div>
  </div>

  <!-- ìŠ¬ë¡¯5 -->
  <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
    <input id="customTitle-5" type="text" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
    <div style="display:flex; gap: 8px; margin-bottom: 10px;">
      <button onclick="saveCustomEstimate(5)">ğŸ“¥ ì €ì¥</button>
      <button onclick="loadCustomEstimate(5)">ğŸ“‚ í™•ì¸</button>
    </div>
  </div>
</div>
<div id="summaryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; border-radius:12px; width:90%; max-width:900px; position:relative;">
    <button onclick="toggleSummaryModal()" style="position:absolute; top:10px; right:10px; font-size:24px; background:none; border:none; cursor:pointer;">âœ•</button>
    <h3 style="margin-top:0; text-align:center;">ì •ë¦¬ëœ ê²¬ì  ë‚´ìš©</h3>
    <textarea id="modalSummaryText" style="width:100%; height:400px;"></textarea>
    <button onclick="copyModalSummaryText()" style="margin-top:10px;">ë³µì‚¬</button>
  </div>
</div>
  </div> <!-- end of flex layout -->

  <div id="imageModal" onclick="closeModal(event)">
  <div id="imageWrapper" style="position: relative; display: inline-block;">
    <img id="modalImage" src="" />
    <!-- ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€ -->
    <button id="closeImageBtn" onclick="closeModal(event)" style="
  position: absolute;
  top: -20px;
  right: -20px;
  font-size: 30px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  z-index: 2000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  transition: background 0.3s;
" onmouseover="this.style.background='rgba(0,0,0,0.6)'" onmouseout="this.style.background='rgba(0,0,0,0.8)'">Ã—</button>
  </div>

  <button id="prevBtn">â†</button>
  <button id="nextBtn">â†’</button>
</div>

  <script>
  const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbxOo_V_B5LmE3f-SHWm6QunvUdl2aPvTOdOEz_wPp8KreAE6wSU9Fe22WM2rXPqgYiP/exec";
const CUSTOM_CATEGORY_ORDER = [
  "íƒ€ì¼", "ì–‘ë³€ê¸°(ì›í”¼ìŠ¤)", "ì–‘ë³€ê¸°(íˆ¬í”¼ìŠ¤)", "ì„¸ë©´ê¸°", "íƒ‘ë³¼",
  "í•˜ë¶€ì¥", "ì„¸ë©´ìˆ˜ì „", "ìƒ¤ì›Œê¸°", "í•´ë°”ë¼ê¸°", "ìŠ¬ë¼ì´ë“œì¥",
  "ìš•ì‹¤ì¥", "í”Œë©ì¥", "ìƒ Â· í•˜ë‹¨ì¥", "ê±°ìš¸", "ìŠ¬ë¼ì´ë“œë°”",
  "ìˆ˜ê±´ê±¸ì´", "íœ´ì§€ê±¸ì´", "ëŒ€ë¦¬ì„", "ì½”ë„ˆì„ ë°˜", "ìŠ¤í”„ë ˆì´ê±´",
  "ìš•ì¡°", "íŒŒí‹°ì…˜", "ì²œì¥"
];
  let materials = {};
  let selected = [];
  let currentCategory = "";
  let currentSort = "";
  let isAdminMode = false;

  async function fetchMaterials() {
document.getElementById("loadingSpinner").style.display = "block";
    const res = await fetch(SHEETS_API_URL);
    const data = await res.json();
    materials = {};
    data.forEach(item => {
      if (!materials[item.category]) materials[item.category] = [];
materials[item.category].push({
  name: item.name,
  price: parseInt(item.price),
  img1: item.img1 || item.img,
  img2: item.img2 || item.img,
 isBest: item.isBest?.toString().toUpperCase() === "TRUE",
  isBasic: item.isBasic?.toString().toUpperCase() === "TRUE",
  soldOut: item.soldOut?.toString().toUpperCase() === "TRUE"
});
    });
    if (currentCategory) showItems(currentCategory);

  document.getElementById("loadingSpinner").style.display = "none";  // ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
}

  function selectCategory(category) {
    currentCategory = category;
    document.getElementById('currentCategoryText').innerText = category;
    document.getElementById('addAllSetButton').style.display = (category === 'ì„¸íŠ¸') ? 'block' : 'none';
    showItems(category);
  }

function showItems(category) {
  const container = document.getElementById('items');
  container.innerHTML = '';

  // âœ… ë©”ì¸ ì¹´í…Œê³ ë¦¬ ì „ìš© ì¶œë ¥
 if (category === 'ë©”ì¸') {
    // ğŸ‘‰ ìƒë‹¨ íƒ€ì´í‹€ê³¼ ì •ë ¬ ìˆ¨ê¸°ê¸°
    document.querySelector('.items h3').style.display = 'none';
    document.querySelector('.sort-box').style.display = 'none';

    const items = materials[category] ? [...materials[category]] : [];
    const limitedItems = items.slice(0, 9);  // 9ê°œê¹Œì§€ë§Œ ì œí•œ

    const grid = document.createElement('div');
    grid.style = `
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    `;

  limitedItems.forEach(item => {
  const div = document.createElement('div');
  div.className = 'item';
  div.style.padding = '0';
  div.innerHTML = `
    <img src="${item.img1}" 
         style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px; cursor:pointer;" 
         onclick="openModal('${item.img1}', '${item.img2 || item.img1}')">
    <div class="name" style="display:none;">${item.name}</div>  <!-- ì´ë¦„ì€ ì¡´ì¬í•˜ì§€ë§Œ ìˆ¨ê¹€ -->
  `;
  grid.appendChild(div);
});

    container.appendChild(grid);
    return;  // âœ… ë©”ì¸ì¼ ê²½ìš° ì—¬ê¸°ì„œ ë°”ë¡œ ì¢…ë£Œ (ë‚˜ë¨¸ì§€ ì½”ë“œ ì‹¤í–‰ ì•ˆí•¨)
  }

  // âœ… ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ ì§„ì…ì‹œ ë‹¤ì‹œ ë³´ì´ê²Œ
  document.querySelector('.items h3').style.display = 'block';
  document.querySelector('.sort-box').style.display = 'block';

  // âœ… ì„¸íŠ¸ ì¹´í…Œê³ ë¦¬ì¼ ë•Œ ì»¤ìŠ¤í…€ ì…ë ¥í¼ ì¶”ê°€
  if (category === 'ì„¸íŠ¸') {
  container.innerHTML += `
    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 10px;">
      <label>ì´ë¦„: <input type="text" id="customName" style="width: 120px;"></label>
      <label>ê¸ˆì•¡: <input type="number" id="customPrice" style="width: 120px;"></label>
      <label>ìˆ˜ëŸ‰: <input type="number" id="customQty" value="1" min="1" style="width: 60px;"></label>
      <button onclick="addCustomSetItem()">ì¶”ê°€</button>
    </div>
  `;
}

  let items = materials[category] ? [...materials[category]] : [];

  if (currentSort === 'name') {
    items.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
  } else if (currentSort === 'price') {
    items.sort((a, b) => a.price - b.price);
  }
  items.sort((a, b) => {
    if (a.isBest && !b.isBest) return -1;
    if (!a.isBest && b.isBest) return 1;
    return 0;
  });

    items.forEach((item, i) => {
  const div = document.createElement('div');
  const img2Safe = (item.img2 && item.img2 !== "undefined") ? item.img2 : item.img1;

  div.className = 'item';
  div.innerHTML = `
    ${item.isBest ? `<div class="best-badge">BEST</div>` : ""}
    ${item.isBasic ? `<div class="basic-badge">ê¸°ë³¸í˜•</div>` : ""}
    <div class="soldout-wrapper" style="position: relative;">
  <img 
    src="${item.img1}" 
    data-img1="${item.img1}" 
    data-img2="${img2Safe}" 
    onclick="openModal('${item.img1}', '${img2Safe}')" 
    onmouseover="this.src=this.dataset.img2" 
    onmouseout="this.src=this.dataset.img1"
    style="${item.soldOut ? 'filter: grayscale(100%); opacity: 0.6;' : ''}"
  >
  ${item.soldOut ? `<div class="soldout-overlay">ì¼ì‹œí’ˆì ˆ</div>` : ""}
</div>
    <div class="name">${item.name}</div>
    <div class="price">
      <span id="item-price-${i}">${item.price.toLocaleString()}ì›</span>
      ${isAdminMode ? `<button onclick="editItemPrice(${i})">âœ</button>` : ""}
    </div>
    <div class="control">
      <input type="number" min="1" value="1" id="qty-${item.name}">
      <button onclick="addToEstimate('${category}', '${item.name}')" ${item.soldOut ? 'disabled style="opacity:0.4; cursor:not-allowed;"' : ''}>ì„ íƒ</button>
      ${
        selected.some(sel => sel.name === item.name)
          ? `<button onclick="removeFromEstimate('${item.name}')">ì·¨ì†Œ</button>`
          : ""
      }
    </div>
<button class="detail-btn" onclick="openDetailModal('${item.name}')">ìƒì„¸ë³´ê¸°</button>

${isAdminMode ? `
  <button class="admin-expand-btn" onclick="toggleAdminPanel(${i})">ì¶”ê°€ì˜µì…˜</button>
  <div class="admin-options" id="admin-options-${i}" style="display: none;">
    <button class="best-btn" onclick="uploadImage2('${category}', '${item.name}')">ì´ë¯¸ì§€2 ì¶”ê°€</button>
    ${item.isBest
      ? `<button class="best-btn" onclick="unmarkAsBest('${category}', '${item.name}')">BEST ì‚­ì œ</button>`
      : `<button class="best-btn" onclick="markAsBest('${category}', '${item.name}')">BEST ì¶”ê°€</button>`}
    ${item.isBasic
      ? `<button class="best-btn" onclick="unmarkAsBasic('${category}', '${item.name}')">ê¸°ë³¸í˜• ì‚­ì œ</button>`
      : `<button class="best-btn" onclick="markAsBasic('${category}', '${item.name}')">ê¸°ë³¸í˜• ì¶”ê°€</button>`}
    ${item.soldOut
      ? `<button class="best-btn" onclick="unmarkAsSoldOut('${category}', '${item.name}')">ì¼ì‹œí’ˆì ˆ í•´ì œ</button>`
      : `<button class="best-btn" onclick="markAsSoldOut('${category}', '${item.name}')">ì¼ì‹œí’ˆì ˆ ì¶”ê°€</button>`}
  </div>
` : ""}
`;
      container.appendChild(div);
    });

  updateSelectedBorders();
  }

  function sortMaterials(type) {
    currentSort = type;
    if (currentCategory) showItems(currentCategory);
  }

function toggleAdminPanel(index) {
  const panel = document.getElementById(`admin-options-${index}`);
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

  function addToEstimate(category, name) {
    const item = materials[category].find(i => i.name === name);
    const qtyInput = document.getElementById(`qty-${item.name}`);
    const qty = parseInt(qtyInput.value);

    if (isNaN(qty) || qty <= 0) {
      alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    const existing = selected.find(i => i.name === item.name);
    if (existing) {
      existing.quantity += qty;
    } else {
      selected.push({ ...item, quantity: qty, category });
    }

renderEstimate();
showItems(currentCategory);
}

  function addAllFromSet() {
    const items = materials[currentCategory] || [];
    items.forEach(item => {
      selected.push({ ...item, quantity: 1, category: currentCategory });
    });
    renderEstimate();
  }
// âœ… ì—¬ê¸° ì•„ë˜ì— ì‚½ì…
function updateSelectedBorders() {
  document.querySelectorAll('.item').forEach(div => {
    const name = div.querySelector('.name').textContent;
    const isSelected = selected.some(item => item.name === name);
    if (isSelected) {
      div.classList.add('selected-border');
    } else {
      div.classList.remove('selected-border');
    }
  });
}

function renderEstimate() {
  const list = document.getElementById('selectedItems');
  list.innerHTML = '';

  selected.sort((a, b) => {
    const aIndex = CUSTOM_CATEGORY_ORDER.indexOf(a.category);
    const bIndex = CUSTOM_CATEGORY_ORDER.indexOf(b.category);
    if (aIndex === -1 && bIndex === -1) return 0;
    if (aIndex === -1) return 1;
    if (bIndex === -1) return -1;
    return aIndex - bIndex;
  });

  selected.forEach((item, i) => {
  // âœ… íŠ¹ì • ì¹´í…Œê³ ë¦¬ëŠ” ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ
  const hiddenCategories = ["íƒ€ì¼", "ì‹œê³µë¹„", "ë³„ë„ ì‹œê³µë¹„"];
  if (!isAdminMode && hiddenCategories.includes(item.category)) {
    return;  // ì¼ë°˜ ì‚¬ìš©ìì¼ ê²½ìš° í•´ë‹¹ í•­ëª© ê±´ë„ˆëœ€
  }

  const nameOnly = item.name.split("(")[0];
  const code = item.name.match(/\((.*?)\)/)?.[1] || '';
  list.innerHTML += `
    <li class="estimate-item">
      <img src="${item.img1}" onclick="openModal('${item.img1}', '${item.img2}')">
      <div class="info-line">
        <div>${nameOnly}</div>
        <div>${code} x ${item.quantity}</div>
      </div>
      <div class="price-delete">
        <span ${!isAdminMode ? 'style="display:none;"' : ''}>
          ${(item.price * item.quantity).toLocaleString()}ì›
        </span>
        <button class="delete-btn" onclick="removeItem(${i})">âœ•</button>
      </div>
    </li>
  `;
});

  updateSelectedBorders();
  updateTotal();
  updateCategoryTexts();
}

  function updateTotal() {
  const total = selected.reduce((sum, i) => sum + i.price * i.quantity, 0);
  const totalPriceSpan = document.getElementById('totalPrice');
  const totalWrapper = document.getElementById('totalWrapper');

  if (isAdminMode) {
    totalPriceSpan.textContent = total.toLocaleString();
    totalWrapper.style.display = "block";
  } else {
    totalPriceSpan.textContent = "";
    totalWrapper.style.display = "none";
  }
}

  function summarizeEstimate() {
  const countMap = {};
  selected.forEach(item => {
    if (item.category === "ì‹œê³µë¹„" || item.category === "ë³„ë„ ì‹œê³µë¹„" || item.category === "ì² ê±°") return;
    if (!countMap[item.name]) countMap[item.name] = 0;
    countMap[item.name] += item.quantity;
  });
    const summaryParts = Object.entries(countMap).map(([name, qty]) =>
      qty > 1 ? `${name} ${qty}EA` : name
    );
    summaryParts.push("ë‹¤ìš´ë¼ì´íŠ¸ 2EA");
    document.getElementById("summaryText").value = summaryParts.join(", ");
  }

  function removeItem(index) {
  selected.splice(index, 1);
  renderEstimate();
  showItems(currentCategory);
}

function removeFromEstimate(name) {
  selected = selected.filter(item => item.name !== name);
  renderEstimate();
  updateSelectedBorders();
  showItems(currentCategory);
}

  function toggleAdmin() {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw === "1760") {
    isAdminMode = true;
    document.getElementById('adminPanel').style.display = 'block';
document.getElementById("setCategoryLi").style.display = "list-item";

    // ìì¬ ëª©ë¡ ì¦‰ì‹œ ë°˜ì˜
    if (currentCategory) showItems(currentCategory);

    // âœ… ê²¬ì ì„œë„ ì¦‰ì‹œ ë‹¤ì‹œ ë Œë”ë§
    renderEstimate();
  } else {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  }
}

  function closeAdmin() {
  isAdminMode = false;
  document.getElementById('adminPanel').style.display = 'none';
document.getElementById("setCategoryLi").style.display = "none";

  // ìì¬ ëª©ë¡ ì¼ë°˜ ëª¨ë“œë¡œ ê°±ì‹ 
  if (currentCategory) showItems(currentCategory);

  // âœ… ê²¬ì ì„œë„ ì¦‰ì‹œ ì¼ë°˜ ëª¨ë“œë¡œ ê°±ì‹ 
  renderEstimate();
}

function editItemPrice(index) {
  const span = document.getElementById(`item-price-${index}`);
  const name = span.closest('.item').querySelector('.name').textContent;
  span.innerHTML = `
    <input type="number" id="new-price-${index}" value="" style="width:70px">
    <button onclick="saveItemPrice('${name}', ${index})">ì €ì¥</button>
  `;

  const item = findItemByName(currentCategory, name);
  if (item) {
    document.getElementById(`new-price-${index}`).value = item.price;
  }
}

function saveItemPrice(name, index) {
  const input = document.getElementById(`new-price-${index}`);
  const newPrice = parseInt(input.value);
  const item = findItemByName(currentCategory, name);

  if (!isNaN(newPrice) && newPrice >= 0 && item) {
    item.price = newPrice;

    fetch(SHEETS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        category: currentCategory,
        name: item.name,
        price: newPrice,
        img1: item.img1,
        img2: item.img2
      }),
      mode: "no-cors"
    })
    .then(() => {
      alert("ê°€ê²©ì´ ìˆ˜ì • ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!");
      fetchMaterials();
    })
    .catch(() => {
      alert("ê°€ê²© ìˆ˜ì • ì‹¤íŒ¨!");
    });

    showItems(currentCategory);
  } else {
    alert("ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  }
}

function findItemByName(category, name) {
  return (materials[category] || []).find(i => i.name === name);
}

  function addMaterial() {
    const name = document.getElementById("adminName").value;
    const price = parseInt(document.getElementById("adminPrice").value);
    const file1 = document.getElementById("adminImgFile1").files[0];
    const file2 = document.getElementById("adminImgFile2").files[0];

    if (!name || isNaN(price) || price < 0 || !file1 || !currentCategory) {
  alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”! (ê°€ê²©ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤)");
  return;
}

    const reader1 = new FileReader();
    const reader2 = new FileReader();

    reader1.onload = function (e1) {
      const img1 = e1.target.result;

      if (!file2) {
        const img2 = img1;
        submitMaterial(img1, img2);
      } else {
        reader2.onload = function (e2) {
          const img2 = e2.target.result;
          submitMaterial(img1, img2);
        };
        reader2.readAsDataURL(file2);
      }
    };
    reader1.readAsDataURL(file1);
  }

  function submitMaterial(img1, img2) {
    const name = document.getElementById("adminName").value;
    const price = parseInt(document.getElementById("adminPrice").value);

    fetch(SHEETS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category: currentCategory, name, price, img1, img2 }),
      mode: "no-cors"
    }).then(() => {
      alert("ìì¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
      document.getElementById("adminName").value = "";
      document.getElementById("adminPrice").value = "";
      document.getElementById("adminImgFile1").value = "";
      document.getElementById("adminImgFile2").value = "";
      fetchMaterials().then(() => showItems(currentCategory));
    });
  }

  function closeModal(event) {
    if (event.target.id === 'imageModal' || event.target.tagName === 'BUTTON') {
      document.getElementById('imageModal').style.display = 'none';
      document.getElementById('modalImage').src = '';
    modalImages = [];
    modalIndex = 0;
    }
  }

let modalImages = [];
let modalIndex = 0;

window.onload = function() {
  const panel = document.getElementById("itemsPanel");
  panel.classList.remove("show");
 document.getElementById("setCategoryLi").style.display = "none";

Promise.all([
  fetchMaterials(),
  fetch(`${SHEETS_API_URL}?type=get_all_titles`)
    .then(res => res.json())
    .then(titles => {
      const sortedSlots = Object.entries(titles)
        .sort((a, b) => {
          const timeA = new Date(a[1].lastLoaded).getTime();
          const timeB = new Date(b[1].lastLoaded).getTime();
          return timeB - timeA;
        })
        .map(entry => entry[0]);  // ì—¬ê¸° parseInt ì œê±° (ë¬¸ìì—´ ìœ ì§€)

      const container = document.getElementById("customSaveSlots");
      container.innerHTML = "";

      sortedSlots.forEach(slot => {
        const slotNum = parseInt(slot);  // ë¬¸ìì—´ â†’ ìˆ«ì ë³€í™˜
        if (slotNum < 100) return;       // 1,2,3ë²ˆ ê±´ë„ˆëœ€

        const simpleSlot = slotNum - 100;
        const titleValue = titles[slot]?.title || "";

        const block = document.createElement("div");
        block.style = "display: flex; flex-direction: column; gap: 6px; align-items: center;";
        block.innerHTML = `
          <input id="customTitle-${simpleSlot}" type="text" value="${titleValue}" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
          <div style="display:flex; gap: 8px; margin-bottom: 10px;">
            <button onclick="saveCustomEstimate(${simpleSlot})">ğŸ“¥ ì €ì¥</button>
            <button onclick="loadCustomEstimate(${simpleSlot})">ğŸ“‚ í™•ì¸</button>
          </div>
        `;
        container.appendChild(block);
      });
    }),
fetch(`${SHEETS_API_URL}?type=load_all_details`)
      .then(res => res.json())
      .then(data => {
        detailData = data; // âœ… ì—¬ê¸°ì— ì €ì¥
      })
  ]).then(() => {
    selectCategory('ë©”ì¸');
    setTimeout(() => {
      panel.classList.add("show");
    }, 100);
  });

  history.pushState(null, null, location.href);
  window.addEventListener('popstate', function(event) {
      history.pushState(null, null, location.href);
  });
}

  function openModal(img1, img2) {
    if (!img2 || img2 === "undefined") img2 = img1;
    modalImages = [img1, img2];
    modalIndex = 0;
    showModalImage();
    document.getElementById('imageModal').style.display = 'flex';
// í™”ì‚´í‘œ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
  document.getElementById('prevBtn').onclick = (e) => {
    e.stopPropagation();
    modalIndex = (modalIndex - 1 + modalImages.length) % modalImages.length;
    showModalImage();
  };

  document.getElementById('nextBtn').onclick = (e) => {
    e.stopPropagation();
    modalIndex = (modalIndex + 1) % modalImages.length;
    showModalImage();
  };
  }

  function showModalImage() {
    document.getElementById('modalImage').src = modalImages[modalIndex];
  }

function markAsBest(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBest = true; // ë¡œì»¬ ìƒíƒœ ë¨¼ì € ë°˜ì˜

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBest: true // Google Sheetì— TRUEë¡œ ì €ì¥
    }),
    mode: "no-cors"
  }).then(() => {
    alert("BESTë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    fetchMaterials().then(() => showItems(currentCategory)); // ìµœì‹  ë°ì´í„° ë°˜ì˜
  });
}
function unmarkAsBest(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBest = false;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBest: false
    }),
    mode: "no-cors"
  }).then(() => {
    alert("BESTê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}
function markAsBasic(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBasic = true;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBasic: true
    }),
    mode: "no-cors"
  }).then(() => {
    alert("ê¸°ë³¸í˜•ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}

function unmarkAsBasic(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.isBasic = false;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      isBasic: false
    }),
    mode: "no-cors"
  }).then(() => {
    alert("ê¸°ë³¸í˜•ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}
function clearEstimate() {
  if (confirm("ê²¬ì  í•­ëª©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    selected = [];
    renderEstimate();
    document.getElementById("summaryText").value = "";
    updateEstimateTitle("ê²¬ì ì„œ");
  }
}

function copySummaryText() {
  const textarea = document.getElementById("summaryText");
  textarea.select();
  textarea.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ëŒ€ì‘
  navigator.clipboard.writeText(textarea.value)
    .then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
    .catch(() => alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
}

function loadSavedEstimate(slot) {
  if (!confirm("ì €ì¥ëœ ê²¬ì ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    return;
  }

  document.getElementById("loadingSpinner").style.display = "block";

  fetch(`${SHEETS_API_URL}?slot=${slot}`)
    .then(res => res.json())
    .then(data => {
      selected = data.map(item => ({
        name: item.name,
        price: parseInt(item.price),
        quantity: parseInt(item.quantity),
        category: item.category,
        img1: item.img1,
        img2: item.img2
      }));

      renderEstimate();

      const estimateTitleEl = document.getElementById("estimateTitle");
      if (estimateTitleEl) {
        estimateTitleEl.textContent = slot === 1 ? "ê±°ì‹¤" : slot === 2 ? "ì•ˆë°©" : slot === 3 ? "ì„¸íŠ¸" : "ê²¬ì ì„œ";
      }

      alert(`ì €ì¥${slot}ë²ˆ ê²¬ì ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    })
    .catch(err => {
      alert("ê²¬ì  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err);
    })
    .finally(() => {
      document.getElementById("loadingSpinner").style.display = "none";
    });
}

function saveEstimate(slot) {
  if (selected.length === 0) {
    alert("ì €ì¥í•  ê²¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (!confirm("ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    return;  // ì·¨ì†Œ ì‹œ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
  }

  const payload = selected.map(item => ({
    slot,
    name: item.name,
    price: item.price,
    quantity: item.quantity,
    category: item.category,
    img1: item.img1,
    img2: item.img2
  }));

document.getElementById("loadingSpinner").style.display = "block";

   fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "save", data: payload }),
    mode: "no-cors"
  }).then(() => {
    alert(`ì €ì¥${slot}ë²ˆìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  }).catch(() => {
    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }).finally(() => {
    document.getElementById("loadingSpinner").style.display = "none";
  });
}
function updateEstimateTitle(text) {
  document.getElementById("estimateTitle").textContent = text;
}
function toggleSummaryModal() {
  const modal = document.getElementById("summaryModal");
  const textarea = document.getElementById("summaryText");
  const modalTextarea = document.getElementById("modalSummaryText");

  modalTextarea.value = textarea.value; // ê¸°ì¡´ ìš”ì•½ë‚´ìš© ë³µì‚¬
  modal.style.display = modal.style.display === "flex" ? "none" : "flex";
}

function copyModalSummaryText() {
  const textarea = document.getElementById("modalSummaryText");
  textarea.select();
  document.execCommand("copy");
  alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
}

function updateCategoryTexts() {
  const selectedCategories = selected.map(i => i.category);
  const includesAll = (arr) => arr.every(c => selectedCategories.includes(c));

  const highlight = (id, condition) => {
    const el = document.getElementById(`text-${id}`);
    if (el) {
      el.style.color = condition ? 'red' : 'inherit';
      el.style.fontWeight = condition ? 'bold' : 'normal';
    }
  };

  highlight("íƒ€ì¼", selectedCategories.includes("íƒ€ì¼"));
  highlight("ì–‘ë³€ê¸°", selectedCategories.includes("ì–‘ë³€ê¸°(ì›í”¼ìŠ¤)") || selectedCategories.includes("ì–‘ë³€ê¸°(íˆ¬í”¼ìŠ¤)"));
  highlight("ì„¸ë©´ê¸°", selectedCategories.includes("ì„¸ë©´ê¸°") || selectedCategories.includes("íƒ‘ë³¼") || selectedCategories.includes("í•˜ë¶€ì¥"));
  highlight("ì„¸ë©´ìˆ˜ì „", selectedCategories.includes("ì„¸ë©´ìˆ˜ì „"));
  highlight("ìƒ¤ì›Œê¸°", selectedCategories.includes("ìƒ¤ì›Œê¸°") || selectedCategories.includes("í•´ë°”ë¼ê¸°"));

  const chk1 = selectedCategories.includes("ìŠ¬ë¼ì´ë“œì¥");
  const chk2 = includesAll(["ìš•ì‹¤ì¥", "ê±°ìš¸"]);
  const chk3 = includesAll(["ìƒ Â· í•˜ë‹¨ì¥", "ê±°ìš¸"]);
  highlight("ìš•ì‹¤ì¥", chk1 || chk2 || chk3);

  highlight("ìŠ¬ë¼ì´ë“œë°”", selectedCategories.includes("ìŠ¬ë¼ì´ë“œë°”"));
  highlight("ìˆ˜ê±´ê±¸ì´", selectedCategories.includes("ìˆ˜ê±´ê±¸ì´"));
  highlight("íœ´ì§€ê±¸ì´", selectedCategories.includes("íœ´ì§€ê±¸ì´"));
  highlight("ëŒ€ë¦¬ì„", selectedCategories.includes("ëŒ€ë¦¬ì„"));
  highlight("ì½”ë„ˆì„ ë°˜", selectedCategories.includes("ì½”ë„ˆì„ ë°˜"));
  highlight("ì²œì¥", selectedCategories.includes("ì²œì¥"));
  highlight("ìš•ì¡°", selectedCategories.includes("ìš•ì¡°"));
  highlight("íŒŒí‹°ì…˜", selectedCategories.includes("íŒŒí‹°ì…˜"));
}

function addCustomSetItem() {
  const name = document.getElementById('customName').value.trim();
  const price = parseInt(document.getElementById('customPrice').value);
  const qty = parseInt(document.getElementById('customQty').value);

  if (!name || isNaN(price) || isNaN(qty) || qty <= 0) {
    alert("ì´ë¦„, ê¸ˆì•¡, ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  // ì…ë ¥í•œ ì´ë¦„ì—ì„œ () ì•ë¶€ë¶„ë§Œ ì¶”ì¶œ
  const baseName = name.split("(")[0].trim();

  // selected ë°°ì—´ì—ì„œ ë™ì¼ baseName ì°¾ê¸°
  const existing = selected.find(item => {
    const existingBaseName = item.name.split("(")[0].trim();
    return existingBaseName === baseName;
  });

  if (existing) {
    // ê¸ˆì•¡ë§Œ ëˆ„ì 
    existing.price += price;
  } else {
    // ìƒˆë¡œ ì¶”ê°€
    selected.push({
      name: name,
      price: price,
      quantity: qty,
      category: 'ì„¸íŠ¸',
      img1: '',  
      img2: ''
    });
  }

  renderEstimate();
  document.getElementById('customName').value = '';
  document.getElementById('customPrice').value = '';
  document.getElementById('customQty').value = '1';
}

// ğŸ”§ ìƒˆë¡œìš´ 8ê°œ ì €ì¥ ìŠ¬ë¡¯ì€ slotë²ˆí˜¸ë¥¼ 101~108ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
function saveCustomEstimate(slotNumber) {
  if (selected.length === 0) {
    alert("ì €ì¥í•  ê²¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const titleInput = document.getElementById(`customTitle-${slotNumber}`);
  const title = titleInput.value.trim();

  if (!title) {
    alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  if (!confirm(`"${title}" ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }

  const payload = selected.map(item => ({
    slot: 100 + slotNumber,
    name: item.name,
    price: item.price,
    quantity: item.quantity,
    category: item.category,
    img1: item.img1,
    img2: item.img2
  }));

  document.getElementById("loadingSpinner").style.display = "block";

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "save_custom", data: payload, title: title }),
    mode: "no-cors"
  }).then(() => {
    alert(`${title} ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  }).catch(() => {
    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }).finally(() => {
    document.getElementById("loadingSpinner").style.display = "none";
  });
}

function loadCustomEstimate(slotNumber) {
  if (!confirm("ì €ì¥ëœ ê²¬ì ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    return;
  }

  document.getElementById("loadingSpinner").style.display = "block";

  fetch(`${SHEETS_API_URL}?type=load_custom&slot=${100 + slotNumber}`)
    .then(res => res.json())
    .then(data => {
      if (!data || !data.items || data.items.length === 0) {
        alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      selected = data.items.map(item => ({
        name: item.name,
        price: parseInt(item.price),
        quantity: parseInt(item.quantity),
        category: item.category,
        img1: item.img1,
        img2: item.img2
      }));

      renderEstimate();

      const titleElement = document.getElementById(`customTitle-${slotNumber}`);
      if (titleElement) {
        titleElement.value = data.title || "";
      }

      const estimateTitleEl = document.getElementById("estimateTitle");
      if (estimateTitleEl) {
        estimateTitleEl.textContent = data.title || "ê²¬ì ì„œ";
      }

      fetch(SHEETS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type: "update_last_loaded", slot: 100 + slotNumber }),
        mode: "no-cors"
      }).then(() => {
        reloadSaveSlots();
      });

      alert(`"${data.title}" ê²¬ì ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    })
    .catch(err => {
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err);
    })
    .finally(() => {
      document.getElementById("loadingSpinner").style.display = "none";
    });
}

function reloadSaveSlots() {
  fetch(`${SHEETS_API_URL}?type=get_all_titles`)
    .then(res => res.json())
    .then(titles => {
      const sortedSlots = Object.entries(titles)
        .sort((a, b) => new Date(b[1].lastLoaded) - new Date(a[1].lastLoaded))
        .map(entry => entry[0]);  // ğŸ‘‰ ì—¬ê¸°ì„œëŠ” parseInt í•˜ì§€ë§ˆ (ë¬¸ìì—´ ìœ ì§€)

      const container = document.getElementById("customSaveSlots");
      container.innerHTML = "";

      sortedSlots.forEach(slot => {
        const slotNum = parseInt(slot);  // âœ… ë¬¸ìì—´ â†’ ìˆ«ì ë³€í™˜ ì •í™•íˆ ì—¬ê¸°ì„œ í•¨
        if (slotNum < 100) return;       // âœ… 1,2,3ë²ˆì€ í‘œì‹œ ì•ˆí•¨ (ê±°ì‹¤, ì•ˆë°©, ì„¸íŠ¸ ì œì™¸)

        const simpleSlot = slotNum - 100;
        const titleValue = titles[slot]?.title || "";

        const block = document.createElement("div");
        block.style = "display: flex; flex-direction: column; gap: 6px; align-items: center;";
        block.innerHTML = `
          <input id="customTitle-${simpleSlot}" type="text" value="${titleValue}" placeholder="ì œëª© ì…ë ¥" style="width: 160px; padding: 6px;">
          <div style="display:flex; gap: 8px; margin-bottom: 10px;">
            <button onclick="saveCustomEstimate(${simpleSlot})">ğŸ“¥ ì €ì¥</button>
            <button onclick="loadCustomEstimate(${simpleSlot})">ğŸ“‚ í™•ì¸</button>
          </div>
        `;
        container.appendChild(block);
      });
    })
    .catch(err => {
      console.error("íƒ€ì´í‹€ ì¬ë¡œë“œ ì‹¤íŒ¨", err);
    });
}

let detailData = {};
let currentDetailName = "";

function openDetailModal(name) {
  currentDetailName = name;
  document.getElementById("detailItemName").textContent = name;
  document.getElementById("detailTextArea").value = detailData[name] || "";
  document.getElementById("detailModal").style.display = "flex";
}

function closeDetailModal() {
  document.getElementById("detailModal").style.display = "none";
  currentDetailName = "";
}

function saveDetail() {
  const detail = document.getElementById("detailTextArea").value.trim();
  if (!currentDetailName) return;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: "save_detail",
      name: currentDetailName,
      detail: detail
    }),
    mode: "no-cors"
  }).then(() => {
    alert("ìƒì„¸ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    detailData[currentDetailName] = detail;
    closeDetailModal();
  }).catch(() => {
    alert("ì €ì¥ ì‹¤íŒ¨");
  });
}

function uploadImage2(category, name) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const img2 = reader.result;

      const item = materials[category].find(i => i.name === name);
      if (!item) return;

      fetch(SHEETS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
type: "update_image2",
          category,
          name,
          price: item.price,
          img1: item.img1,
          img2: img2  // âœ… ì´ë¯¸ì§€2ë§Œ ê°±ì‹ 
        }),
        mode: "no-cors"
      }).then(() => {
        alert("ì´ë¯¸ì§€2ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
        fetchMaterials().then(() => showItems(currentCategory));
      }).catch(() => {
        alert("ì´ë¯¸ì§€2 ì¶”ê°€ ì‹¤íŒ¨");
      });
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function markAsSoldOut(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.soldOut = true;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      soldOut: true
    }),
    mode: "no-cors"
  }).then(() => {
    alert("ì¼ì‹œí’ˆì ˆë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}

function unmarkAsSoldOut(category, name) {
  const item = materials[category].find(i => i.name === name);
  if (!item) return;

  item.soldOut = false;

  fetch(SHEETS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      category,
      name,
      price: item.price,
      img1: item.img1,
      img2: item.img2,
      soldOut: false
    }),
    mode: "no-cors"
  }).then(() => {
    alert("ì¼ì‹œí’ˆì ˆ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
    fetchMaterials().then(() => showItems(currentCategory));
  });
}
  </script>

  <div class="admin" id="adminPanel">
    <h3>ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ</h3>
    <label>í˜„ì¬ ì¹´í…Œê³ ë¦¬: <span id="currentCategoryText">-</span></label>
    <label>ìì¬ ì´ë¦„: <input type="text" id="adminName" /></label>
    <label>ê°€ê²©: <input type="number" id="adminPrice" /></label>
    <label>ì´ë¯¸ì§€ 1: <input type="file" id="adminImgFile1" accept="image/*" /></label>
    <label>ì´ë¯¸ì§€ 2: <input type="file" id="adminImgFile2" accept="image/*" /></label>
    <button onclick="addMaterial()">ìì¬ ì¶”ê°€í•˜ê¸°</button>
    <button onclick="closeAdmin()">ê´€ë¦¬ì ëª¨ë“œ ë‹«ê¸°</button>
  </div>

<div id="loadingSpinner" style="
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.8);
  padding: 40px 60px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 9999;
  display: none;
">
  <div style="display: flex; flex-direction: column; align-items: center;">
    <div class="spinner" style="
      width: 50px; height: 50px;
      border: 5px solid #ccc;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    "></div>
    <div style="font-size: 20px;">ë¡œë”©ì¤‘...</div>
  </div>
</div>

<div id="detailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; border-radius:12px; width:90%; max-width:600px; position:relative;">
    <button onclick="closeDetailModal()" style="position:absolute; top:10px; right:10px; font-size:24px; background:none; border:none; cursor:pointer;">âœ•</button>
    <h3 style="margin-top:0; text-align:center;">ìƒì„¸ì •ë³´ ì…ë ¥</h3>
    <div style="margin-bottom: 10px;"><strong id="detailItemName"></strong></div>
    <textarea id="detailTextArea" style="width:100%; height:200px;"></textarea>
    <button onclick="saveDetail()" style="margin-top:10px;">ì €ì¥</button>
  </div>
</div>
</body>
</html>
